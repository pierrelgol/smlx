/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   mat4_2.c                                           :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: pollivie <pollivie@student.42.fr>          +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2024/04/01 13:25:20 by pollivie          #+#    #+#             */
/*   Updated: 2024/04/01 13:25:21 by pollivie         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "../../include/smlx.h"

static void	mat4_init_t(float *t, float *m)
{
	t[0] = m[10] * m[15];
	t[1] = m[14] * m[11];
	t[2] = m[6] * m[15];
	t[3] = m[14] * m[7];
	t[4] = m[6] * m[11];
	t[5] = m[10] * m[7];
	t[6] = m[2] * m[15];
	t[7] = m[14] * m[3];
	t[8] = m[2] * m[11];
	t[9] = m[10] * m[3];
	t[10] = m[2] * m[7];
	t[11] = m[6] * m[3];
	t[12] = m[8] * m[13];
	t[13] = m[12] * m[9];
	t[14] = m[4] * m[13];
	t[15] = m[12] * m[5];
	t[16] = m[4] * m[9];
	t[17] = m[8] * m[5];
	t[18] = m[0] * m[13];
	t[19] = m[12] * m[1];
	t[20] = m[0] * m[9];
	t[21] = m[8] * m[1];
	t[22] = m[0] * m[5];
	t[23] = m[4] * m[1];
}

static void	mat4_out_part1(float *o, float *t, float *m, float *d)
{
	o[0] = (t[0] * m[5] + t[3] * m[9] + t[4] * m[13]) - (t[1] * m[5] + t[2]
			* m[9] + t[5] * m[13]);
	o[1] = (t[1] * m[1] + t[6] * m[9] + t[9] * m[13]) - (t[0] * m[1] + t[7]
			* m[9] + t[8] * m[13]);
	o[2] = (t[2] * m[1] + t[7] * m[5] + t[10] * m[13]) - (t[3] * m[1] + t[6]
			* m[5] + t[11] * m[13]);
	o[3] = (t[5] * m[1] + t[8] * m[5] + t[11] * m[9]) - (t[4] * m[1] + t[9]
			* m[5] + t[10] * m[9]);
	*d = 1.0f / (m[0] * o[0] + m[4] * o[1] + m[8] * o[2] + m[12] * o[3]);
	o[0] = *d * o[0];
	o[1] = *d * o[1];
	o[2] = *d * o[2];
	o[3] = *d * o[3];
}

static void	mat4_out_part2(float *o, float *t, float *m, float d)
{
	o[4] = d * ((t[1] * m[4] + t[2] * m[8] + t[5] * m[12]) - (t[0] * m[4] + t[3]
				* m[8] + t[4] * m[12]));
	o[5] = d * ((t[0] * m[0] + t[7] * m[8] + t[8] * m[12]) - (t[1] * m[0] + t[6]
				* m[8] + t[9] * m[12]));
	o[6] = d * ((t[3] * m[0] + t[6] * m[4] + t[11] * m[12]) - (t[2] * m[0]
				+ t[7] * m[4] + t[10] * m[12]));
	o[7] = d * ((t[4] * m[0] + t[9] * m[4] + t[10] * m[8]) - (t[5] * m[0] + t[8]
				* m[4] + t[11] * m[8]));
	o[8] = d * ((t[12] * m[7] + t[15] * m[11] + t[16] * m[15]) - (t[13] * m[7]
				+ t[14] * m[11] + t[17] * m[15]));
	o[9] = d * ((t[13] * m[3] + t[18] * m[11] + t[21] * m[15]) - (t[12] * m[3]
				+ t[19] * m[11] + t[20] * m[15]));
	o[10] = d * ((t[14] * m[3] + t[19] * m[7] + t[22] * m[15]) - (t[15] * m[3]
				+ t[18] * m[7] + t[23] * m[15]));
	o[11] = d * ((t[17] * m[3] + t[20] * m[7] + t[23] * m[11]) - (t[16] * m[3]
				+ t[21] * m[7] + t[22] * m[11]));
	o[12] = d * ((t[14] * m[10] + t[17] * m[14] + t[13] * m[6]) - (t[16] * m[14]
				+ t[12] * m[6] + t[15] * m[10]));
	o[13] = d * ((t[20] * m[14] + t[12] * m[2] + t[19] * m[10]) - (t[18] * m[10]
				+ t[21] * m[14] + t[13] * m[2]));
	o[14] = d * ((t[18] * m[6] + t[23] * m[14] + t[15] * m[2]) - (t[22] * m[14]
				+ t[14] * m[2] + t[19] * m[6]));
	o[15] = d * ((t[22] * m[10] + t[16] * m[2] + t[21] * m[6]) - (t[20] * m[6]
				+ t[23] * m[10] + t[17] * m[2]));
}

t_mat4x4	mat4_inverse(t_mat4x4 matrix)
{
	t_mat4x4	out;
	float		*m;
	float		*t;
	float		d;

	m = matrix.data;
	t = (float [24]){0};
	out = mat4_create();
	mat4_init_t(t, m);
	mat4_out_part1(out.data, t, m, &d);
	mat4_out_part2(out.data, t, m, d);
	return (out);
}
